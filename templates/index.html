<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - TaskManager</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* All your CSS styles remain unchanged */
    /* Base Styles */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    .container {
      max-width: 1100px;
      margin: 30px auto 0;
      padding: 0 15px;
    }

    h2 {
      margin-bottom: 20px;
    }

    /* Navbar & Branding */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #3498db;
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .brand img {
      width: 40px;
      height: 40px;
      border-radius: 5px;
    }

    .brand h1 {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: 600;
      font-size: 1.8rem;
      color: white;
      margin: 0;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }

    /* User Section */
    .user-info-bar {
      background-color: #f8f9fa;
      padding: 10px 0;
      border-bottom: 1px solid #dee2e6;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .welcome-msg {
      font-size: 1.1rem;
      font-weight: 500;
      color: #495057;
    }

    .logout-btn, .logout-button {
      padding: 8px 16px;
      font-size: 0.9rem;
      background-color: white;
      color: #dc3545;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .logout-btn:hover, .logout-button:hover {
      background-color: #f2f2f2;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-lg {
      padding: 12px 24px;
      font-size: 1.1rem;
      min-width: 220px;
      text-align: center;
    }

    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }

    .button-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      margin: 1.5rem 0;
    }

    /* Forms */
    .form-container {
      max-width: 500px;
      margin: 0 auto;
      padding: 1rem;
    }

    .compact-form {
      padding: 1rem;
    }

    .compact-form .form-control,
    .compact-form .form-select {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }

    .compact-form .form-label {
      margin-bottom: 0.2rem;
      font-size: 0.875rem;
    }

    .btn-submit {
      margin-top: 10px;
    }

    /* Tables */
    .table {
      margin-top: 20px;
      width: 100%;
    }

    .table th {
      background-color: #4CAF50;
      color: white;
      padding: 0.5rem;
    }

    .table td {
      padding: 0.3rem 0.5rem;
      vertical-align: middle;
    }

    .table tr:hover {
      background-color: #f5f5f5;
    }

    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Tooltips */
    input[title]:hover:after {
      content: attr(title);
      padding: 5px 10px;
      color: #333;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      position: absolute;
      left: 0;
      top: 100%;
      z-index: 100;
      width: 200px;
      margin-top: 5px;
    }

    /* Modals & Popups */
    .popup-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .popup-container.show {
      opacity: 1;
    }

    .popup-content {
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      max-width: 80%;
      text-align: center;
    }

    .popup-content button {
      margin-top: 15px;
      padding: 5px 15px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .modal-dialog {
      max-width: 600px;
    }

    /* Toast Notifications */
    .swal2-toast {
      font-size: 14px !important;
      padding: 10px 15px !important;
    }

    .swal2-success {
      background-color: #4CAF50 !important;
    }

    .swal2-error {
      background-color: #dc3545 !important;
    }

    /* Animations & Transitions */
    #taskListContainer {
      transition: all 0.3s ease;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .navbar {
        flex-direction: column;
        padding: 10px;
      }

      .brand h1 {
        font-size: 1.5rem;
      }

      .user-section {
        margin-top: 10px;
      }

      .welcome-msg {
        font-size: 1rem;
      }

      .logout-btn {
        padding: 6px 12px;
        font-size: 0.8rem;
      }

      table {
        display: block;
        overflow-x: auto;
      }

      .btn-lg {
        min-width: auto;
        width: 100%;
      }
    }

    /* Main Content Container */
    .main-content {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 15px;
    }

    /* Form Section */
    .form-section {
      margin-bottom: 1.5rem;
    }

    /* Search and Filter Row */
    .search-filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 300px;
    }

    .filter-buttons {
      display: flex;
      gap: 0.5rem;
    }

    /* Progress Bar Section */
    .progress-section {
      margin: 1.5rem 0;
    }

    .progress {
      height: 30px;
      border-radius: 15px;
    }

    .progress-bar {
      font-size: 0.95rem;
      font-weight: 500;
    }

    /* Status Filter Buttons */
    .status-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .status-filters .btn {
      flex: 1;
      min-width: 120px;
    }

    /* Table Container */
    .table-container {
      width: 100%;
      overflow-x: auto;
      margin-bottom: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .table {
      margin-bottom: 0;
      font-size: 0.9rem;
    }

    .table th {
      padding: 0.75rem;
      white-space: nowrap;
    }

    .table td {
      padding: 0.75rem;
      vertical-align: middle;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .search-filter-row {
        flex-direction: column;
      }

      .search-box,
      .filter-buttons {
        width: 100%;
      }

      .status-filters .btn {
        min-width: calc(50% - 0.5rem);
      }
    }

    @media (max-width: 576px) {
      .status-filters .btn {
        min-width: 100%;
      }
    }

    /* Add this to your CSS */
    .main-content {
      margin-top: 2rem; /* Adds space below the header */
      padding-top: 1rem;
    }

    /* Update these color styles */
    .navbar {
      background-color: #2c3e50; /* Darker blue for navbar */
    }

    .btn-primary {
      background-color: #3498db;
      border-color: #2980b9;
    }

    .btn-primary:hover {
      background-color: #2980b9;
    }

    .btn-success {
      background-color: #27ae60;
      border-color: #219653;
    }

    .btn-warning {
      background-color: #f39c12;
      border-color: #e67e22;
    }

    .btn-info {
      background-color: #00b4d8; /* Brighter info blue */
      border-color: #0096c7;
    }

    .btn-danger {
      background-color: #e74c3c;
      border-color: #c0392b;
    }

    /* Form styling */
    #taskFormContainer {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
    }

    /* Status filter buttons */
    .btn-outline-primary {
      color: #3498db;
      border-color: #3498db;
    }

    .btn-outline-warning {
      color: #f39c12;
      border-color: #f39c12;
    }

    .btn-outline-info {
      color: #00b4d8;
      border-color: #00b4d8;
    }

    .btn-outline-success {
      color: #27ae60;
      border-color: #27ae60;
    }

    /* Table action buttons */
    .btn-sm.btn-primary {
      background-color: #3498db;
    }

    .btn-sm.btn-info {
      background-color: #00b4d8;
    }

    .btn-sm.btn-danger {
      background-color: #e74c3c;
    }

    /* Progress bar */
    .progress-bar {
      background-color: #27ae60;
    }

    body {
      background-color: #f8fafa;
    }

    body {
      background: linear-gradient(120deg, #f8f9fa, #e9ecef);
    }

    body {
      font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
    }

    .card {
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .cursor-pointer {
      cursor: pointer;
    }

    .btn-primary {
      background-color: #0dc1fd;
      border-color: #7398ce;
    }

    .btn-primary:hover {
      background-color: #abbbd3;
    }

    .btn-secondary {
      background-color: #6c757d;
      border-color: #6f8c93;
    }

    .btn-secondary:hover {
      background-color: #8fa2b5;
    }

    #taskList .card:hover {
      transform: scale(1.01);
      transition: transform 0.2s ease;
    }

    th, td {
      vertical-align: middle !important;
    }

    #taskSection {
      padding: 30px;
      border-radius: 12px;
      background-color: #ffffff;
      box-shadow: 0 0 20px rgba(0,0,0,0.05);
    }

    #taskDetailsSection {
      background-color: #fefefe;
    }

    .progress {
      height: 24px;
      border-radius: 8px;
      overflow: hidden;
    }

    .progress-bar {
      font-weight: bold;
      font-size: 14px;
    }

    .table thead th {
      background-color: #343a40 !important;
      color: white;
    }

    .btn-group .btn {
      border-radius: 0.375rem;
    }

    #taskList .table {
      margin-bottom: 40px;
      border-radius: 10px;
      overflow: hidden;
    }

    /* Add these styles */
    .header-spacer {
      margin: 1.5rem 0;
    }

    .card {
      border-radius: 10px;
      overflow: hidden;
    }

    .table {
      border-collapse: separate;
      border-spacing: 0;
    }

    .table th {
      background-color: #2c3e50 !important; /* Matching navbar */
    }

    .table tr:hover {
      background-color: #f8f9fa !important;
    }

    .btn-lg {
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Status badges */
    .badge-primary {
      background-color: #3498db;
    }
    .badge-warning {
      background-color: #f39c12;
    }
    .badge-info {
      background-color: #00b4d8;
    }
    .badge-success {
      background-color: #27ae60;
    }

    /* Welcome message styling */
    .text-center.py-5 {
      padding: 3rem 0;
    }

    .fa-tasks.fa-4x {
      opacity: 0.7;
    }

    /* Add to your existing CSS */
    .progress-section, .table-container {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Status filter buttons */
    .status-filters .btn {
      transition: all 0.2s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Make sure buttons don't jump when counts appear */
    .status-filters .btn i {
      margin-right: 4px;
    }
      .notification-popup {
    max-height: 80vh;
    overflow-y: auto;
}
.notification-item {
    transition: all 0.3s ease;
}
/* ===== DARK THEME ===== */
.dark-mode {
  background-color: #121212;
  color: #e0e0e0;
  transition: all 0.3s ease;
}

/* Navigation */
.dark-mode .navbar {
  background-color: #1e1e1e !important;
  border-bottom: 1px solid #2d2d2d;
}

.dark-mode .user-info-bar {
  background-color: #1e1e1e !important;
  border-bottom: 1px solid #2d2d2d;
}

.dark-mode .welcome-msg {
  color: #e0e0e0 !important;
}

/* Cards and containers */
.dark-mode .card {
  background-color: #1e1e1e;
  color: #e0e0e0;
  border: 1px solid #2d2d2d;
}

.dark-mode #taskFormContainer,
.dark-mode #taskSection {
  background-color: #1e1e1e;
  color: #e0e0e0;
}

/* Tables */
.dark-mode .table {
  background-color: #1e1e1e;
  color: #e0e0e0;
}

.dark-mode .table th {
  background-color: #2d2d2d !important;
  color: #ffffff;
  border-color: #3d3d3d;
}

.dark-mode .table td {
  background-color: #1e1e1e;
  color: #e0e0e0;
  border-color: #3d3d3d;
}

.dark-mode .table-hover tbody tr:hover {
  background-color: #2d2d2d !important;
  color: #ffffff;
}

.dark-mode .table-container {
  background-color: #1e1e1e;
}

/* Forms */
.dark-mode .form-control,
.dark-mode .form-select {
  background-color: #2d2d2d;
  color: #e0e0e0;
  border: 1px solid #3d3d3d;
}

.dark-mode .form-control:focus,
.dark-mode .form-select:focus {
  background-color: #2d2d2d;
  color: #e0e0e0;
  border-color: #0dc1fd;
  box-shadow: 0 0 0 0.2rem rgba(13, 193, 253, 0.25);
}

.dark-mode .form-label {
  color: #e0e0e0;
}

/* Buttons */
.dark-mode .btn-outline-primary {
  color: #0dc1fd;
  border-color: #0dc1fd;
}

.dark-mode .btn-outline-primary:hover {
  background-color: #0dc1fd;
  border-color: #0dc1fd;
  color: #121212;
}

.dark-mode .btn-outline-light {
  color: #e0e0e0;
  border-color: #e0e0e0;
}

.dark-mode .btn-outline-light:hover {
  background-color: #e0e0e0;
  color: #121212;
}

.dark-mode .btn-primary {
  background-color: #0dc1fd;
  border-color: #0dc1fd;
}

.dark-mode .btn-primary:hover {
  background-color: #0ab0e6;
  border-color: #0ab0e6;
}

.dark-mode .btn-info {
  background-color: #17a2b8;
  border-color: #17a2b8;
}

.dark-mode .btn-info:hover {
  background-color: #138496;
  border-color: #138496;
}

/* Status filter buttons */
.dark-mode .status-filters .btn {
  background-color: #2d2d2d;
  color: #e0e0e0;
  border: 1px solid #3d3d3d;
}

.dark-mode .status-filters .btn-primary {
  background-color: #0dc1fd;
  border-color: #0dc1fd;
  color: #121212;
}

.dark-mode .status-filters .btn-success {
  background-color: #28a745;
  border-color: #28a745;
  color: #ffffff;
}

.dark-mode .status-filters .btn-warning {
  background-color: #ffc107;
  border-color: #ffc107;
  color: #121212;
}

.dark-mode .status-filters .btn-info {
  background-color: #17a2b8;
  border-color: #17a2b8;
  color: #ffffff;
}

/* Modals */
.dark-mode .modal-content {
  background-color: #1e1e1e;
  color: #e0e0e0;
  border: 1px solid #2d2d2d;
}

.dark-mode .modal-header {
  background-color: #2d2d2d;
  color: #ffffff;
  border-bottom: 1px solid #3d3d3d;
}

.dark-mode .modal-footer {
  border-top: 1px solid #3d3d3d;
}

/* Dropdowns */
.dark-mode .dropdown-menu {
  background-color: #1e1e1e;
  border: 1px solid #2d2d2d;
}

.dark-mode .dropdown-item {
  color: #e0e0e0;
}

.dark-mode .dropdown-item:hover {
  background-color: #2d2d2d;
  color: #ffffff;
}

.dark-mode .dropdown-header {
  color: #a0a0a0;
}

/* Progress bars */
.dark-mode .progress {
  background-color: #2d2d2d;
}

.dark-mode .progress-bar {
  background-color: #0dc1fd;
}

/* List groups */
.dark-mode .list-group-item {
  background-color: #1e1e1e;
  color: #e0e0e0;
  border: 1px solid #2d2d2d;
}

.dark-mode .list-group-item:hover {
  background-color: #2d2d2d;
}

/* Text colors */
.dark-mode .text-muted {
  color: #a0a0a0 !important;
}

.dark-mode .bg-light {
  background-color: #2d2d2d !important;
  color: #e0e0e0 !important;
}

/* Badges */
.dark-mode .badge-primary {
  background-color: #0dc1fd;
}

.dark-mode .badge-info {
  background-color: #17a2b8;
}

.dark-mode .badge-success {
  background-color: #28a745;
}

.dark-mode .badge-warning {
  background-color: #ffc107;
  color: #121212;
}

/* Borders */
.dark-mode .border {
  border-color: #2d2d2d !important;
}

/* Task details */
.dark-mode .task-details .bg-light {
  background-color: #2d2d2d !important;
  color: #e0e0e0 !important;
}

/* Notification items */
.dark-mode .notification-item {
  background-color: #1e1e1e;
  color: #e0e0e0;
}

.dark-mode .notification-item.bg-light {
  background-color: #2d2d2d !important;
}

/* Chart.js canvas background */
.dark-mode canvas {
  background-color: #1e1e1e;
  border-radius: 5px;
  padding: 10px;
}
.list-group-item:hover {
    background-color: #f8f9fa;
}

.task-details .bg-light {
    background-color: #f8f9fa !important;
    white-space: pre-wrap;
}
    /* Smooth transitions for all elements */
body, .card, .btn, .form-control, .table, .modal-content, .dropdown-menu {
  transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}

/* Custom scrollbar for dark mode */
.dark-mode ::-webkit-scrollbar {
  width: 8px;
}

.dark-mode ::-webkit-scrollbar-track {
  background: #1e1e1e;
}

.dark-mode ::-webkit-scrollbar-thumb {
  background: #2d2d2d;
  border-radius: 4px;
}

.dark-mode ::-webkit-scrollbar-thumb:hover {
  background: #3d3d3d;
}
    /* Fix search bar placeholder visibility */
.form-control::placeholder {
    color: #6c757d !important;
    opacity: 1 !important;
}

.dark-mode .form-control::placeholder {
    color: #a0a0a0 !important;
}

/* Ensure search input text is visible */
.form-control {
    color: #495057 !important;
}

.dark-mode .form-control {
    color: #e0e0e0 !important;
}
/* Progress bar styles */
#uploadProgressContainer {
    transition: all 0.3s ease;
}

.progress {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
}

.progress-bar {
    transition: width 0.3s ease;
    font-weight: bold;
}
    /* Add to your existing CSS */
.dark-mode .card-header.bg-light {
    background-color: #2d2d2d !important;
    color: #e0e0e0 !important;
    border-bottom: 1px solid #3d3d3d;
}

.dark-mode .card {
    background-color: #1e1e1e;
    border-color: #2d2d2d;
}

.dark-mode .card-body {
    background-color: #1e1e1e;
}

/* Ensure chart canvas has proper background */
.dark-mode canvas {
    background-color: #1e1e1e;
    border-radius: 8px;
}

/* Style for active timeframe buttons in dark mode */
.dark-mode .btn-group .btn-primary {
    background-color: #0dc1fd;
    border-color: #0dc1fd;
    color: #121212;
}

.dark-mode .btn-group .btn-outline-primary {
    color: #0dc1fd;
    border-color: #0dc1fd;
}

.dark-mode .btn-group .btn-outline-primary:hover {
    background-color: #0dc1fd;
    color: #121212;
}
    /* Chart container styles */
.card-body canvas {
    max-height: 250px;
    width: 100% !important;
    height: 250px !important;
}

/* Ensure charts are responsive */
.chart-container {
    position: relative;
    height: 250px;
    width: 100%;
}

/* Dark mode chart adjustments */
.dark-mode .card-body canvas {
    background-color: #1e1e1e;
    border-radius: 8px;
    padding: 10px;
}

/* Button group styling for timeframe selector */
.btn-group .btn {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

/* Analytics overview cards */
.analytics-card {
    transition: all 0.3s ease;
}

.analytics-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.dark-mode .analytics-card:hover {
    box-shadow: 0 10px 20px rgba(255,255,255,0.05);
}
    .card h3 {
  font-size: 2rem;
  margin: 0;
}

.card span {
  font-size: 0.9rem;
  white-space: nowrap; /* prevents breaking into 2 lines */
}

  </style>
</head>
<body>
 <nav class="navbar navbar-expand-lg">
  <div class="container-fluid justify-content-between">  <!-- Changed to justify-content-between -->
    <div class="brand">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
      <h1 class="m-0">TaskManager</h1>
    </div>
    <button class="btn btn-outline-light me-2" id="darkModeToggle">
  <i class="fas fa-moon"></i>
</button>
    <!-- NOTIFICATION BELL - MOVED TO NAVBAR -->
    <div class="nav-item dropdown">
      <button class="btn btn-outline-light position-relative dropdown-toggle"
              id="notificationDropdown" data-bs-toggle="dropdown">
        <i class="fas fa-bell"></i>
        <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
          0
        </span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown">
        <li><h6 class="dropdown-header">Notifications</h6></li>
        <div id="notificationList" class="px-2">
          <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            <span class="ms-2">Loading notifications...</span>
          </div>
        </div>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item text-center small" href="#" data-bs-toggle="modal" data-bs-target="#manageNotificationsModal" onclick="loadAllNotificationsToModal()">Manage Notifications</a></li>
      </ul>
    </div>
  </div>
</nav>

  <div class="user-info-bar">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col text-start text-md-center ps-md-5">
        <span class="welcome-msg">Welcome, {{ session.get('username') }}</span>
      </div>
      <div class="col text-end text-md-center pe-md-5">
        <form action="/logout" method="post">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
          <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
    Delete Account
</button>
        </form>
      </div>
    </div>
  </div>
</div>
  <div class="header-spacer" style="height: -20px;"></div>

  <div class="container main-content">
    <!-- Add Task Button and Form -->
    <div class="form-section text-center">
      <button id="toggleTaskForm" class="btn btn-primary btn-lg mb-3">
        <i class="fas fa-plus"></i> <span id="toggleButtonText">Add New Task</span>
      </button>

      <div id="taskFormContainer" style="display: none;" class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title mb-4">Add New Task</h5>
          <form action="/add_task" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-2">
              <label for="title" class="form-label">Task Title</label>
              <input type="text" class="form-control" id="title" name="title" required>
            </div>
            <div class="mb-2">
              <label for="description" class="form-label">Description</label>
              <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label for="deadline" class="form-label">Deadline</label>
              <input type="date" class="form-control" id="deadline" name="deadline" required>
            </div>
            <button type="submit" class="btn btn-success w-100 mt-3">
              <i class="fas fa-check me-2"></i> Submit Task
            </button>
          </form>
        </div>
      </div>

      <!-- Replace the entire shared-tasks-section with this -->
      <div class="text-center mb-4">
        <button class="btn btn-outline-primary position-relative" data-bs-toggle="modal" data-bs-target="#sharedTasksModal">
          <i class="fas fa-users me-2"></i> View Shared Tasks
          <span id="sharedTasksBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
            0
          </span>
        </button>
      </div>
      <!-- ADD THIS BUTTON -->
  <button class="btn btn-info ms-2" data-bs-toggle="modal" data-bs-target="#analyticsModal">
    <i class="fas fa-chart-line me-2"></i> Analytics Dashboard
  </button>
</div>
      <!-- Status Filters -->
      <div class="status-filters">
        <a href="/?status=all" class="btn {% if selected_status == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
          <i class="fas fa-tasks"></i> View All{% if selected_status == 'all' %} ({{ total_count }}){% endif %}
        </a>
        <a href="/?status=Pending" class="btn {% if selected_status == 'Pending' %}btn-warning text-dark{% else %}btn-outline-warning{% endif %}">
          <i class="fas fa-clock"></i> Pending{% if selected_status == 'Pending' %} ({{ Pending_count }}){% endif %}
        </a>
        <a href="/?status=In Progress" class="btn {% if selected_status == 'In Progress' %}btn-info text-dark{% else %}btn-outline-info{% endif %}">
          <i class="fas fa-spinner"></i> In Progress{% if selected_status == 'In Progress' %} ({{ In_Progress_count }}){% endif %}
        </a>
        <a href="/?status=Completed" class="btn {% if selected_status == 'Completed' %}btn-success{% else %}btn-outline-success{% endif %}">
          <i class="fas fa-check-circle"></i> Completed{% if selected_status == 'Completed' %} ({{ Completed_count }}){% endif %}
        </a>
      </div>
      <!-- Search and Sort Row -->
      <div class="search-filter-row">
        <div class="search-box">
          <form method="get" class="d-flex gap-2">
            <input type="hidden" name="status" value="{{ selected_status }}">
            <input class="form-control" type="search" placeholder="Search by title" name="search" value="{{ search_query or '' }}">
            <button class="btn btn-outline-primary" type="submit">
              <i class="fas fa-search"></i> Search
            </button>
          </form>
        </div>
        <div class="filter-buttons">
          <a href="{{ url_for('index', search=request.args.get('search', ''), status=request.args.get('status', ''), sort='deadline') }}"
             class="btn btn-outline-secondary">
            <i class="fas fa-sort-amount-down"></i> Sort by Deadline
          </a>
        </div>
      </div>

      <!-- Only show these sections when a filter is selected -->
      {% if show_components %}
      <!-- Progress Bar -->
      <div class="progress-section">
        <div class="progress">
          <div id="taskProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
               role="progressbar" style="width: {{ overall_completed_percentage }}%;"
               aria-valuenow="{{ overall_completed_percentage }}" aria-valuemin="0" aria-valuemax="100">
            {{ overall_completed_percentage }}% Completed
          </div>
        </div>
      </div>

      <!-- Task Table -->
      <div class="table-container">
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>Title</th>
              <th>Deadline</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if not tasks %}
              <tr>
                <td colspan="4" class="text-center">
                  No tasks found here
                </td>
              </tr>
            {% else %}
              {% for task in tasks %}
              <tr data-task-id="{{ task.id }}">
                <td>{{ task.title }}</td>
                <td>{{ task.deadline }}</td>
                <td>{{ task.status }}</td>
                <td>
                  <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm"
                      onclick="editTask('{{ task.id }}', '{{ task.title }}', `{{ task.description }}`, '{{ task.deadline }}', '{{ task.status }}')">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-info" onclick='showDetails({{ task | tojson | safe }})'>
                      <i class="fas fa-info-circle"></i> Details
                    </button>
                    <!-- ADD SHARE BUTTON HERE -->
                    <button class="btn btn-warning btn-sm" onclick="openShareModal('{{ task.id }}', '{{ task.title }}')">
                      <i class="fas fa-share"></i> Share
                    </button>
                    <form action="/delete_task/{{ task.id }}" method="POST" style="display: inline;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-danger btn-sm"
                              onclick="return confirmDelete('{{ task.title }}')">
                        <i class="fas fa-trash-alt"></i> Delete
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>


 <!-- Enhanced Task Details Modal with Attachments -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="taskModalLabel">Task Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Task details will be injected here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

  <!-- Edit Task Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <form method="POST" action="/update" class="modal-content">
        <!-- ADD THIS CSRF TOKEN INPUT -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="modal-header">
          <h5 class="modal-title">Edit Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editTaskId" name="task_id">
          <div class="mb-3">
            <label>Title</label>
            <input type="text" id="editTaskTitle" name="title" class="form-control">
          </div>
          <div class="mb-3">
            <label>Description</label>
            <textarea id="editTaskDescription" name="description" class="form-control"></textarea>
          </div>
          <div class="mb-3">
            <label>Deadline</label>
            <input type="date" id="editTaskDeadline" name="deadline" class="form-control">
          </div>
          <div class="mb-3">
            <label>Status</label>
            <select id="editTaskStatus" name="status" class="form-select">
              <option value="Pending">Pending</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" type="submit">Update Task</button>
        </div>
      </form>
    </div>
  </div>
<!-- Share Task Modal -->
  <div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Share Task: <span id="shareTaskTitle"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Enter username to share with:</label>
            <input type="text" id="shareUsername" class="form-control" placeholder="Username">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" onclick="shareTask()">
            <i class="fas fa-share"></i> Share Task
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Shared Tasks Modal - EXTRA LARGE -->
  <div class="modal fade" id="sharedTasksModal" tabindex="-1" aria-labelledby="sharedTasksModalLabel" aria-hidden="true">
      <div class="modal-dialog" style="max-width: 700px;">  <!-- Custom width -->
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="sharedTasksModalLabel">
            <i class="fas fa-users me-2"></i>Tasks Shared With Me
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="text-center mb-3">
            <button class="btn btn-outline-primary btn-sm" onclick="loadSharedTasks()">
              <i class="fas fa-sync"></i> Refresh Shared Tasks
            </button>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="table-light">
                <tr>
                  <th>Title</th>
                  <th>Deadline</th>
                  <th>Status</th>
                  <th>Shared By</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="sharedTasksList">
                <tr>
                  <td colspan="5" class="text-center">Click refresh to load shared tasks</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
<!-- Analytics Modal -->
<div class="modal fade" id="analyticsModal" tabindex="-1" aria-labelledby="analyticsModalLabel" aria-hidden="true">
     <div class="modal-dialog" style="max-width: 700px;">  <!-- Custom width -->
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="analyticsModalLabel">
          <i class="fas fa-chart-line me-2"></i>Task Analytics Dashboard
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Overview Stats -->
        <div class="row mb-4" id="analyticsOverview">
          <div class="col-md-12 text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
          <!-- Status Distribution Chart -->
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-header bg-light">
                <h6 class="card-title mb-0">Task Status Distribution</h6>
              </div>
              <div class="card-body">
                <canvas id="statusChart" height="250"></canvas>
              </div>
            </div>
          </div>

          <!-- Completion Trends Chart -->
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="card-title mb-0">Completion Trends</h6>
                  <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-timeframe="weekly">
                      Weekly
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="monthly">
                      Monthly
                    </button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <canvas id="trendsChart" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- Manage Notifications Modal -->
<div class="modal fade" id="manageNotificationsModal" tabindex="-1" aria-labelledby="manageNotificationsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="manageNotificationsModalLabel">
          <i class="fas fa-bell me-2"></i>Manage Notifications
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between mb-3">
          <button class="btn btn-success" onclick="markAllAsRead()">
            <i class="fas fa-check-double me-2"></i>Mark All as Read
          </button>
          <button class="btn btn-danger" onclick="deleteAllNotifications()">
            <i class="fas fa-trash-alt me-2"></i>Delete All Notifications
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Message</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="allNotificationsList">
              <tr>
                <td colspan="4" class="text-center py-4">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2">Loading notifications...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
 <!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="deleteAccountForm" method="POST">
   <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Confirm Account Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <p class="text-danger fw-bold">
            Warning: This action cannot be undone. All your tasks and account data will be permanently deleted.
        </p>
        <div class="mb-3">
            <label for="password" class="form-label">Enter your password to confirm</label>
            <input type="password" class="form-control" id="password" name="password" required>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-danger">Delete Account</button>
    </div>
</form>

    </div>
  </div>
</div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Add this before your custom scripts -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    function showDetails(task) {
    const modalBody = document.getElementById("modalBody");

    // Show loading state
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading task details...</p>
        </div>
    `;

    // Fetch attachments for this task
    fetch(`/tasks/${task.id}/attachments`)
    .then(response => response.json())
    .then(attachments => {
        const attachmentsHtml = attachments.length > 0 ? `
            <div class="mt-4">
                <h6>Attachments (${attachments.length})</h6>
                <div class="list-group">
                    ${attachments.map(att => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file me-2"></i>
                                <a href="/tasks/${task.id}/attachments/${att.filename}"
                                   download="${att.original_name}"
                                   class="text-decoration-none">
                                    ${att.original_name}
                                </a>
                                <small class="d-block text-muted">${formatFileSize(att.size)} â€¢ ${new Date(att.uploaded_at).toLocaleDateString()}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAttachment('${task.id}', '${att.filename}', '${att.original_name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : `
            <div class="mt-4">
                <p class="text-muted">No attachments</p>
            </div>
        `;

        // Create the main task details HTML
        modalBody.innerHTML = `
            <div class="task-details">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Title:</strong> ${task.title}</p>
                        <p><strong>Status:</strong> <span class="badge bg-info">${task.status}</span></p>
                        <p><strong>Deadline:</strong> ${task.deadline || 'No deadline'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Created At:</strong> ${task.created_at ? new Date(task.created_at).toLocaleString() : 'Unknown'}</p>
                        ${task.updated_at ? `<p><strong>Last Updated:</strong> ${new Date(task.updated_at).toLocaleString()}</p>` : ''}
                    </div>
                </div>

                <div class="mt-3">
                    <strong>Description:</strong>
                    <div class="border p-3 mt-1 rounded bg-light">
                        ${task.description || 'No description'}
                    </div>
                </div>

                ${attachmentsHtml}

                <!-- File Upload Form -->
<div class="mt-4">
    <h6>Add Attachment</h6>
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="input-group">
            <input type="file" class="form-control" id="fileInput" name="file" required>
            <button class="btn btn-primary" type="submit" id="uploadButton">
                <i class="fas fa-upload"></i> Upload
            </button>
        </div>
        <small class="form-text text-muted">
            Max file size: 16MB. Allowed types: txt, pdf, png, jpg, jpeg, gif, doc, docx, zip
        </small>

        <!-- Progress Bar Container (Initially hidden) -->
        <div id="uploadProgressContainer" class="mt-2" style="display: none;">
            <div class="d-flex justify-content-between">
                <small>Uploading...</small>
                <small id="uploadPercentage">0%</small>
            </div>
            <div class="progress" style="height: 20px;">
                <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                </div>
            </div>
        </div>
    </form>
</div>
            </div>
        `;

        // Add event listener for file upload
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    uploadAttachment(task.id);
});
    })
    .catch(error => {
        console.error('Error loading attachments:', error);
        modalBody.innerHTML = `
            <div class="alert alert-danger">
                Error loading task details. Please try again.
            </div>
        `;
    });

    const myModal = new bootstrap.Modal(document.getElementById('taskModal'));
    myModal.show();
}

// Helper function to format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
// Function to upload attachment
// Function to upload attachment
// Function to upload attachment with progress bar
function uploadAttachment(taskId) {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    const uploadBtn = document.getElementById('uploadButton');
    const progressContainer = document.getElementById('uploadProgressContainer');
    const progressBar = document.getElementById('uploadProgressBar');
    const percentageText = document.getElementById('uploadPercentage');

    if (!file) {
        alert('Please select a file to upload');
        return;
    }

    // Get CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;

    // Show progress bar, disable button
    progressContainer.style.display = 'block';
    uploadBtn.disabled = true;
    const originalBtnText = uploadBtn.innerHTML;
    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Uploading...';

    // Reset progress bar
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', 0);
    percentageText.textContent = '0%';

    // Create FormData and XMLHttpRequest for progress tracking
    const formData = new FormData();
    formData.append('file', file);

    const xhr = new XMLHttpRequest();

    // Progress event handler
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            const percentRounded = Math.round(percentComplete);

            // Update progress bar
            progressBar.style.width = percentComplete + '%';
            progressBar.setAttribute('aria-valuenow', percentComplete);
            percentageText.textContent = percentRounded + '%';

            // Change color when complete
            if (percentComplete === 100) {
                progressBar.classList.remove('progress-bar-animated');
            }
        }
    });

    // Load event handler (when upload completes)
    xhr.addEventListener('load', function() {
        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);

            if (response.error) {
                // Show error
                progressBar.classList.add('bg-danger');
                percentageText.textContent = 'Error!';
                Swal.fire('Error', response.error, 'error');
            } else {
                // Show success
                progressBar.classList.add('bg-success');
                percentageText.textContent = 'Complete!';

                // Close modal and show success message
                const currentModal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                currentModal.hide();

                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'File uploaded successfully!',
                    showConfirmButton: false,
                    timer: 3000
                });

                // Reopen modal after delay to refresh content
                setTimeout(() => {
                    const task = { id: taskId };
                    showDetails(task);
                }, 1000);
            }
        } else {
            // Handle HTTP errors
            progressBar.classList.add('bg-danger');
            percentageText.textContent = 'Upload failed!';
            Swal.fire('Error', 'Upload failed: ' + xhr.statusText, 'error');
        }

        // Re-enable button after a delay
        setTimeout(() => {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalBtnText;
        }, 2000);
    });

    // Error event handler
    xhr.addEventListener('error', function() {
        progressBar.classList.add('bg-danger');
        percentageText.textContent = 'Upload failed!';
        Swal.fire('Error', 'Upload failed. Please try again.', 'error');

        uploadBtn.disabled = false;
        uploadBtn.innerHTML = originalBtnText;
    });

    // Open and send the request
    xhr.open('POST', `/tasks/${taskId}/attachments`);
    xhr.setRequestHeader('X-CSRFToken', csrfToken);
    xhr.send(formData);
}
// Function to delete attachment
function deleteAttachment(taskId, filename, originalName) {
    if (!confirm(`Are you sure you want to delete "${originalName}"?`)) {
        return;
    }

    // Get CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;

    fetch(`/tasks/${taskId}/attachments/${filename}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            // Refresh the task details
            const task = { id: taskId };
            showDetails(task);
            // Show success message using Swal directly
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Attachment deleted successfully!',
                showConfirmButton: false,
                timer: 3000
            });
        }
    })
    .catch(error => {
        console.error('Error deleting attachment:', error);
        alert('Error deleting attachment: ' + error.message);
    });
}
    function confirmDelete(taskTitle) {
      return confirm(`Are you sure you want to delete "${taskTitle}"?`);
    }

    // Update the DOMContentLoaded event for task highlighting
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll("table tbody tr");
    const now = new Date();

    rows.forEach(row => {
        const deadlineText = row.children[1].innerText.trim();
        if (!deadlineText) return;

        const deadline = new Date(deadlineText);
        const timeDiff = deadline - now;
        const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

        // Add visual indicators based on urgency
        if (daysDiff < 0) {
            // Past due - most urgent
            row.style.backgroundColor = "#ffcccc";
            row.children[1].innerHTML += ' <span class="badge bg-danger">Overdue</span>';
        } else if (daysDiff === 0) {
            // Due today
            row.style.backgroundColor = "#ffe6cc";
            row.children[1].innerHTML += ' <span class="badge bg-warning text-dark">Due Today</span>';
        } else if (daysDiff === 1) {
            // Due tomorrow
            row.style.backgroundColor = "#ffffcc";
            row.children[1].innerHTML += ' <span class="badge bg-info">Tomorrow</span>';
        } else if (daysDiff <= 3) {
            // Due in 1-3 days
            row.style.backgroundColor = "#f8f9fa";
            row.children[1].innerHTML += ` <span class="badge bg-secondary">${daysDiff} days</span>`;
        }

        // Add tooltip with exact time remaining
        row.children[1].title = `Due: ${deadline.toLocaleDateString()}`;
    });
});
    function editTask(id, title, description, deadline, status) {
      // Format date for input[type=date]
      let formattedDeadline = '';
      if (deadline) {
        const dateParts = deadline.split('-');
        if (dateParts.length === 3) {
          formattedDeadline = deadline; // Already in YYYY-MM-DD format
        } else {
          // Handle other date formats if needed
          const dateObj = new Date(deadline);
          formattedDeadline = dateObj.toISOString().split('T')[0];
        }
      }

      document.getElementById("editTaskId").value = id;
      document.getElementById("editTaskTitle").value = title;
      document.getElementById("editTaskDescription").value = description;
      document.getElementById("editTaskDeadline").value = formattedDeadline;
      document.getElementById("editTaskStatus").value = status;

      new bootstrap.Modal(document.getElementById("editModal")).show();
    }

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        document.addEventListener('DOMContentLoaded', function() {
          {% for category, message in messages %}
            showToast('{{ category }}', '{{ message }}');
          {% endfor %}
        });
      {% endif %}
    {% endwith %}

    function closePopup() {
      document.getElementById('errorPopup').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.querySelector('form[action="/add_task"]').addEventListener('submit', function(e) {
        e.preventDefault(); // Always prevent default first

        const form = e.target;
        const title = form.querySelector('#title').value.trim();
        const description = form.querySelector('#description').value.trim();
        const deadline = form.querySelector('#deadline').value;
        const submitBtn = form.querySelector('button[type="submit"]');

        // Validate inputs
        let isValid = true;

        if (!title) {
          showToast('error', 'Task title is required');
          isValid = false;
        }

        if (!description) {
          showToast('error', 'Task description is required');
          isValid = false;
        }

        if (deadline) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const deadlineDate = new Date(deadline);
          deadlineDate.setHours(0, 0, 0, 0);

          if (deadlineDate < today) {
            showToast('error', 'Deadline cannot be in the past');
            isValid = false;
          }
        }

        // Only submit if valid
        if (isValid) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
          form.submit(); // Manually submit if valid
        }
      });

      function showToast(type, message) {
        const Toast = Swal.mixin({
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 3000,
          timerProgressBar: true,
          didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer);
            toast.addEventListener('mouseleave', Swal.resumeTimer);
          }
        });

        Toast.fire({
          icon: type,
          title: message
        });
      }
    });

    let currentTaskId = '';

    function openShareModal(taskId, taskTitle) {
      currentTaskId = taskId;
      document.getElementById('shareTaskTitle').textContent = taskTitle;
      document.getElementById('shareUsername').value = '';
      new bootstrap.Modal(document.getElementById('shareModal')).show();
    }

    function shareTask() {
    const username = document.getElementById('shareUsername').value.trim();

    if (!username) {
        alert('Please enter a username');
        return;
    }

    console.log('Sharing task:', currentTaskId, 'with user:', username);

    // Get CSRF token from the form - FIXED SELECTOR
    const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;

    if (!csrfToken) {
        alert('Error: CSRF token not found. Please try again.');
        return;
    }

    console.log('CSRF Token found:', csrfToken ? 'Yes' : 'No');

    // Create form data
    const formData = new FormData();
    formData.append('username', username);
    formData.append('csrf_token', csrfToken);

    fetch(`/tasks/${currentTaskId}/share`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`Server returned ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            // Use SweetAlert for better notification
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: data.message,
                timer: 3000,
                showConfirmButton: false
            });

            // Close the modal
            const shareModal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
            if (shareModal) {
                shareModal.hide();
            }
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        alert('Error sharing task: ' + error.message);
    });
}
    function loadSharedTasks() {
      // Show loading state
      const container = document.getElementById('sharedTasksList');
      container.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Loading shared tasks...</td></tr>';

      fetch('/tasks/shared')
      .then(response => response.json())
      .then(tasks => {
        if (tasks.length === 0) {
          container.innerHTML = '<tr><td colspan="5" class="text-center">No tasks shared with you yet.</td></tr>';
          return;
        }

        container.innerHTML = tasks.map(task => `
          <tr>
            <td><strong>${task.title}</strong></td>
            <td>${task.deadline || 'No deadline'}</td>
            <td><span class="badge bg-info">${task.status}</span></td>
            <td>${task.owner}</td>
            <td>
  <div class="d-flex gap-2">  <!-- This creates spacing between buttons -->
    <button class="btn btn-sm btn-info" onclick='showSharedTaskDetails(${JSON.stringify(task)})'>
      <i class="fas fa-eye me-1"></i> View Details  <!-- me-1 adds space between icon and text -->
    </button>
    <button class="btn btn-sm btn-danger" onclick='removeSharedTask("${task.id}", "${task.title}")'>
      <i class="fas fa-trash me-1"></i> Remove  <!-- me-1 adds space between icon and text -->
    </button>
  </div>
</td>
          </tr>
        `).join('');
      })
      .catch(error => {
        console.error('Error loading shared tasks:', error);
        container.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading shared tasks</td></tr>';
      });
    }

    // Auto-load shared tasks when modal opens
document.getElementById('sharedTasksModal').addEventListener('show.bs.modal', function () {
    loadSharedTasks();
});

    function showSharedTaskDetails(task) {
    // First store the shared modal instance
    const sharedModal = bootstrap.Modal.getInstance(document.getElementById('sharedTasksModal'));

    // Hide the shared modal but don't dispose it
    sharedModal.hide();

    const modalBody = document.getElementById("modalBody");

    // Show loading state
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading task details...</p>
        </div>
    `;

    // Fetch attachments for this shared task
    fetch(`/shared/tasks/${task.id}/attachments`)
    .then(response => response.json())
    .then(attachments => {
        const attachmentsHtml = attachments.length > 0 ? `
            <div class="mt-4">
                <h6>Attachments (${attachments.length})</h6>
                <div class="list-group">
                    ${attachments.map(att => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file me-2"></i>
                                <a href="/shared/tasks/${task.id}/attachments/${att.filename}"
                                   download="${att.original_name}"
                                   class="text-decoration-none">
                                    ${att.original_name}
                                </a>
                                <small class="d-block text-muted">${formatFileSize(att.size)} â€¢ ${new Date(att.uploaded_at).toLocaleDateString()}</small>
                            </div>
                            <!-- Shared users can only view, not delete -->
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : `
            <div class="mt-4">
                <p class="text-muted">No attachments</p>
            </div>
        `;

        // Create the main task details HTML
        modalBody.innerHTML = `
            <div class="task-details">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Title:</strong> ${task.title}</p>
                        <p><strong>Status:</strong> <span class="badge bg-info">${task.status}</span></p>
                        <p><strong>Deadline:</strong> ${task.deadline || 'No deadline'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Created At:</strong> ${task.created_at ? new Date(task.created_at).toLocaleString() : 'Unknown'}</p>
                        <p><strong>Shared by:</strong> ${task.owner}</p>
                        ${task.updated_at ? `<p><strong>Last Updated:</strong> ${new Date(task.updated_at).toLocaleString()}</p>` : ''}
                    </div>
                </div>

                <div class="mt-3">
                    <strong>Description:</strong>
                    <div class="border p-3 mt-1 rounded bg-light">
                        ${task.description || 'No description'}
                    </div>
                </div>

                ${attachmentsHtml}

                <!-- Shared users cannot upload attachments -->
                <div class="mt-4">
                    <p class="text-muted small">
                        <i class="fas fa-info-circle"></i> Only the task owner can add attachments.
                    </p>
                </div>
            </div>
        `;
    })
    .catch(error => {
        console.error('Error loading shared task attachments:', error);
        modalBody.innerHTML = `
            <div class="alert alert-danger">
                Error loading task details. Please try again.
            </div>
        `;
    });

    const detailsModal = new bootstrap.Modal(document.getElementById('taskModal'));
    detailsModal.show();

    // When details modal closes, reopen the shared modal
    document.getElementById('taskModal').addEventListener('hidden.bs.modal', function () {
        sharedModal.show();
    }, { once: true });
}
    function updateSharedTasksBadge() {
      fetch('/tasks/shared')
      .then(response => response.json())
      .then(tasks => {
        const badge = document.getElementById('sharedTasksBadge');
        if (tasks.length > 0) {
          badge.style.display = 'block';
          badge.textContent = tasks.length;
        } else {
          badge.style.display = 'none';
        }
      });
    }

    // Update badge when page loads
    document.addEventListener('DOMContentLoaded', function() {
      updateSharedTasksBadge();
    });

    document.getElementById('toggleTaskForm').addEventListener('click', function() {
      const formContainer = document.getElementById('taskFormContainer');
      const buttonText = document.getElementById('toggleButtonText');

      if (formContainer.style.display === 'none' || !formContainer.style.display) {
        formContainer.style.display = 'block';
        buttonText.textContent = 'Hide Form';
        this.querySelector('i').className = 'fas fa-minus';
      } else {
        formContainer.style.display = 'none';
        buttonText.textContent = 'Add New Task';
        this.querySelector('i').className = 'fas fa-plus';
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      // Store the selected filter in session when a filter button is clicked
      document.querySelectorAll('.status-filters a').forEach(link => {
        link.addEventListener('click', function(e) {
          const filter = new URL(this.href).searchParams.get('status');
          // Store in session storage
          sessionStorage.setItem('lastFilter', filter);
        });
      });

      // Highlight the active filter button
      const currentFilter = new URL(window.location.href).searchParams.get('status');
      if (currentFilter) {
        const activeButton = document.querySelector(`.status-filters a[href*="status=${currentFilter}"]`);
        if (activeButton) {
          // Remove outline classes and add solid ones
          activeButton.classList.remove('btn-outline-primary', 'btn-outline-warning', 'btn-outline-info', 'btn-outline-success');
          if (currentFilter === 'all') activeButton.classList.add('btn-primary');
          else if (currentFilter === 'Pending') activeButton.classList.add('btn-warning');
          else if (currentFilter === 'In Progress') activeButton.classList.add('btn-info');
          else if (currentFilter === 'Completed') activeButton.classList.add('btn-success');
        }
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      // This is now handled server-side, so we can remove the client-side search
      // or keep it for instant filtering of already loaded results

      // Optional: Client-side filtering for better UX
      const searchInput = document.querySelector('input[name="search"]');
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          const filter = this.value.toLowerCase();
          const rows = document.querySelectorAll("tbody tr");

          rows.forEach(row => {
            const titleCell = row.querySelector("td:nth-child(1)");
            if (titleCell) {
              const titleText = titleCell.textContent.toLowerCase();
              row.style.display = titleText.includes(filter) ? "" : "none";
            }
          });
        });
      }
    });

  </script>
<script>
// Load and display notifications
function loadNotifications(limit = 4) {
    fetch('/notifications')
    .then(response => {
        if (!response.ok) throw new Error('Failed to load notifications');
        return response.json();
    })
    .then(notifications => {
        const container = document.getElementById('notificationList');
        const badge = document.getElementById('notificationBadge');

        const unreadCount = notifications.filter(n => !n.is_read).length;

        // Update badge
        if (unreadCount > 0) {
            badge.style.display = 'block';
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        } else {
            badge.style.display = 'none';
        }

        // Display notifications (limited)
        const displayNotifications = notifications.slice(0, limit);

        if (displayNotifications.length === 0) {
            container.innerHTML = '<div class="text-center py-3 text-muted">No notifications</div>';
            return;
        }

        container.innerHTML = displayNotifications.map(notif => `
            <div class="notification-item mb-2 p-2 border-start border-3 border-${notif.type} ${notif.is_read ? '' : 'bg-light'}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <small class="d-block">${notif.message}</small>
                        <small class="text-muted">${new Date(notif.created_at).toLocaleString()}</small>
                    </div>
                    ${!notif.is_read ? `
<button class="btn btn-sm btn-outline-secondary ms-2" onclick="markAsRead('${notif._id}', this)">
    <i class="fas fa-check"></i>
</button>` : ''}
                </div>
            </div>
        `).join('');
    })
    .catch(error => {
        console.error('Error loading notifications:', error);
        const container = document.getElementById('notificationList');
        container.innerHTML = '<div class="text-center py-3 text-danger">Error loading notifications</div>';
    });
}

// Load all notifications (for "View All" button)
function loadAllNotifications() {
    // Close the dropdown first
    const dropdown = new bootstrap.Dropdown(document.getElementById('notificationDropdown'));
    dropdown.hide();

    // Show all notifications in a modal or separate page
    fetch('/notifications/all')
    .then(response => {
        if (!response.ok) throw new Error('Failed to load all notifications');
        return response.json();
    })
    .then(notifications => {
        if (notifications.length === 0) {
            alert('No notifications');
            return;
        }

        // Create a simple alert with all notifications
        const notificationText = notifications.map(notif =>
            `â€¢ ${notif.message} (${new Date(notif.created_at).toLocaleString()})`
        ).join('\n');

        Swal.fire({
            title: 'All Notifications',
            text: notificationText,
            scrollbarPadding: false,
            width: '80%',
            customClass: {
                popup: 'notification-popup'
            }
        });
    })
    .catch(error => {
        console.error('Error loading all notifications:', error);
        alert('Error loading notifications');
    });
}

// Mark notification as read (updated for both views)
function markAsRead(notificationId, element) {
    // Get CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;

    if (!csrfToken) {
        console.error('CSRF token not found');
        return;
    }

    // Show loading state
    let targetElement = element;
    if (element && element.tagName === 'BUTTON') {
        targetElement = element.parentNode.parentNode;
    }

    if (targetElement) {
        const originalHtml = targetElement.innerHTML;
        targetElement.innerHTML = '<td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm"></div></td>';
    }

    fetch(`/notifications/${notificationId}/read`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to mark as read');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // If in dropdown, update that view
            const dropdownItem = document.querySelector(`.notification-item button[onclick*="${notificationId}"]`)?.closest('.notification-item');
            if (dropdownItem) {
                dropdownItem.classList.remove('bg-light');
                const checkButton = dropdownItem.querySelector('button[onclick*="markAsRead"]');
                if (checkButton) checkButton.remove();
            }

            // If in modal, update that view
            if (targetElement && targetElement.tagName === 'TR') {
                targetElement.classList.remove('table-info');
                targetElement.cells[2].innerHTML = '<span class="badge bg-secondary">Read</span>';
                const markReadBtn = targetElement.querySelector('button[onclick*="markAsRead"]');
                if (markReadBtn) markReadBtn.remove();
            }

            // Update badge count
            updateNotificationBadge();
        }
    })
    .catch(error => {
        console.error('Error marking notification as read:', error);
        if (targetElement && targetElement.tagName === 'TR') {
            // Reload the modal content on error
            loadAllNotificationsToModal();
        }
    });
}
// Load notifications when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadNotifications();

    // Load notifications when dropdown opens
    document.getElementById('notificationDropdown').addEventListener('show.bs.dropdown', function () {
        loadNotifications();
    });
});
</script>
<script>
// Load all notifications (for "View All" button)
function loadAllNotifications() {
    // Close the dropdown first
    const dropdown = new bootstrap.Dropdown(document.getElementById('notificationDropdown'));
    dropdown.hide();

    // Show all notifications in a modal
    fetch('/notifications/all')
    .then(response => {
        if (!response.ok) throw new Error('Failed to load all notifications');
        return response.json();
    })
    .then(notifications => {
        if (notifications.length === 0) {
            Swal.fire({
                title: 'All Notifications',
                html: '<div class="text-center py-3 text-muted">No notifications found</div>',
                confirmButtonText: 'Close'
            });
            return;
        }

        // Create formatted HTML for notifications
        const notificationsHtml = `
            <div class="notifications-container" style="max-height: 60vh; overflow-y: auto;">
                ${notifications.map(notif => `
                    <div class="notification-item p-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <p class="mb-1">${notif.message}</p>
                                <small class="text-muted">${new Date(notif.created_at).toLocaleString()}</small>
                            </div>
                            <span class="badge bg-${notif.type} ms-2">${notif.type}</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        Swal.fire({
            title: 'All Notifications',
            html: notificationsHtml,
            width: '600px',
            showCloseButton: true,
            showConfirmButton: false,
            customClass: {
                popup: 'notification-popup'
            }
        });
    })
    .catch(error => {
        console.error('Error loading all notifications:', error);
        Swal.fire({
            title: 'Error',
            text: 'Failed to load notifications',
            icon: 'error',
            confirmButtonText: 'Close'
        });
    });
}
// Function to delete a single notification (updated for both views)
function deleteNotification(notificationId, element) {
    // Get CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;

    if (!csrfToken) {
        console.error('CSRF token not found');
        return;
    }

    // Show loading state
    let targetElement = element;
    if (element && element.tagName === 'BUTTON') {
        targetElement = element.parentNode.parentNode;
    }

    if (targetElement) {
        const originalHtml = targetElement.innerHTML;
        targetElement.innerHTML = '<td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm"></div></td>';
    }

    fetch(`/notifications/${notificationId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to delete notification');
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }

        // Remove from dropdown if exists
        const dropdownItem = document.querySelector(`.notification-item button[onclick*="${notificationId}"]`)?.closest('.notification-item');
        if (dropdownItem) {
            dropdownItem.remove();
        }

        // Remove from modal if exists
        if (targetElement && targetElement.tagName === 'TR') {
            targetElement.remove();
        }

        // Update badge count
        updateNotificationBadge();

        // Show success message
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: 'Notification deleted successfully!',
            showConfirmButton: false,
            timer: 3000
        });
    })
    .catch(error => {
        console.error('Error deleting notification:', error);
        alert('Error deleting notification: ' + error.message);
        if (targetElement && targetElement.tagName === 'TR') {
            // Reload the modal content on error
            loadAllNotificationsToModal();
        }
    });
}
// Function to mark all notifications as read
function markAllAsRead() {
    // Get CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;

    // Show loading state
    const markAllBtn = document.querySelector('#manageNotificationsModal .btn-success');
    const originalHtml = markAllBtn.innerHTML;
    markAllBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Processing...';
    markAllBtn.disabled = true;

    fetch('/notifications/read_all', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            // Show success message
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: `Marked ${data.modified_count || 0} notifications as read`,
                showConfirmButton: false,
                timer: 3000
            });

            // Refresh both dropdown and modal
            loadNotifications();
            loadAllNotificationsToModal();
        }
    })
    .catch(error => {
        console.error('Error marking all as read:', error);
        alert('Error marking all as read: ' + error.message);
    })
    .finally(() => {
        // Restore button state
        markAllBtn.innerHTML = originalHtml;
        markAllBtn.disabled = false;
    });
}

// Function to delete all notifications
function deleteAllNotifications() {
    // Confirmation dialog first
    Swal.fire({
        title: 'Are you sure?',
        text: "This will delete all your notifications. This action cannot be undone.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete all!'
    }).then((result) => {
        if (result.isConfirmed) {
            // Get CSRF token
            const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;

            // Show loading state
            const deleteAllBtn = document.querySelector('#manageNotificationsModal .btn-danger');
            const originalHtml = deleteAllBtn.innerHTML;
            deleteAllBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Processing...';
            deleteAllBtn.disabled = true;

            fetch('/notifications/delete_all', {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    // Show success message
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: `Deleted ${data.deleted_count || 0} notifications`,
                        showConfirmButton: false,
                        timer: 3000
                    });

                    // Refresh both dropdown and modal
                    loadNotifications();
                    loadAllNotificationsToModal();
                }
            })
            .catch(error => {
                console.error('Error deleting all notifications:', error);
                alert('Error deleting all notifications: ' + error.message);
            })
            .finally(() => {
                // Restore button state
                deleteAllBtn.innerHTML = originalHtml;
                deleteAllBtn.disabled = false;
            });
        }
    });
}
// Helper function to update the notification badge count
function updateNotificationBadge() {
    // This will be called when notifications are updated via socket
    loadNotifications();
}
  // Function to load all notifications into the management modal
function loadAllNotificationsToModal() {
    const container = document.getElementById('allNotificationsList');
    container.innerHTML = '<tr><td colspan="4" class="text-center py-4"><div class="spinner-border" role="status"></div><p class="mt-2">Loading notifications...</p></td></tr>';

    fetch('/notifications/all')
    .then(response => {
        if (!response.ok) throw new Error('Failed to load all notifications');
        return response.json();
    })
    .then(notifications => {
        if (notifications.length === 0) {
            container.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No notifications found</td></tr>';
            return;
        }

        container.innerHTML = notifications.map(notif => `
            <tr class="${notif.is_read ? '' : 'table-info'}">
                <td>${notif.message}</td>
                <td><small class="text-muted">${new Date(notif.created_at).toLocaleString()}</small></td>
                <td>
                    <span class="badge bg-${notif.is_read ? 'secondary' : 'primary'}">
                        ${notif.is_read ? 'Read' : 'Unread'}
                    </span>
                </td>
                <td>
                    ${!notif.is_read ? `
                    <button class="btn btn-sm btn-outline-success" onclick="markAsRead('${notif._id}', this.parentNode.parentNode)">
                        <i class="fas fa-check"></i>
                    </button>` : ''}
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteNotification('${notif._id}', this.parentNode.parentNode)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    })
    .catch(error => {
        console.error('Error loading all notifications:', error);
        container.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-danger">Error loading notifications</td></tr>';
    });
}
</script>
<script>
// Initialize Socket.IO connection only if user is logged in
document.addEventListener('DOMContentLoaded', function() {
    const userId = '{{ session.get("user_id") }}';

    if (userId && typeof io !== 'undefined') {
        try {
            console.log('Initializing Socket.IO connection...');

            // Initialize Socket.IO with proper configuration
            const socket = io({
                transports: ['websocket', 'polling'],
                upgrade: true,
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                timeout: 20000
            });

            // Connection established
            socket.on('connect', function() {
                console.log('Socket.IO connected successfully');
                // Send user ID to server to join user-specific room
                socket.emit('join', { userId: userId });
            });

            // Handle custom notification events
            socket.on('notification', function(data) {
                console.log('New real-time notification:', data);

                // Show toast notification
                Swal.fire({
                    title: 'New Notification',
                    text: data.message,
                    icon: 'info',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });

                // Refresh notification list if dropdown is open
                const dropdown = document.getElementById('notificationDropdown');
                if (dropdown.classList.contains('show')) {
                    loadNotifications();
                }

                // Update badge
                const badge = document.getElementById('notificationBadge');
                const currentCount = parseInt(badge.textContent) || 0;
                badge.style.display = 'block';
                badge.textContent = currentCount + 1;
            });

            socket.on('connected', function(data) {
                console.log('Server connection confirmed:', data.message);
            });

            // Handle connection errors
            socket.on('connect_error', function(error) {
                console.error('Socket.IO connection error:', error);
                // Don't fall back to polling to avoid spam
            });

            socket.on('disconnect', function(reason) {
                console.log('Socket.IO disconnected:', reason);
                if (reason === 'io server disconnect') {
                    // The server has forcibly disconnected the socket, need to reconnect manually
                    socket.connect();
                }
            });

        } catch (error) {
            console.error('Socket.IO initialization error:', error);
        }
    } else {
        console.log('Socket.IO not initialized (user not logged in or library missing)');
    }

    // Load initial notifications
    loadNotifications();

    // Load notifications when dropdown opens
    document.getElementById('notificationDropdown').addEventListener('show.bs.dropdown', function () {
        loadNotifications();
    });
});
// Handle notification updates from server
socket.on('notifications_updated', function(data) {
    console.log('Notifications updated, refreshing...');
    // Refresh the notification list if dropdown is open
    const dropdown = document.getElementById('notificationDropdown');
    if (dropdown.classList.contains('show')) {
        loadNotifications();
    }
    // Always update the badge
    updateNotificationBadge();
});
</script>
<script>
// Analytics functionality
let statusChart = null;
let trendsChart = null;

// Load analytics when modal opens
document.getElementById('analyticsModal').addEventListener('show.bs.modal', function () {
    loadAnalyticsData();
});

function loadAnalyticsData() {
    loadOverviewStats();
    loadStatusDistribution();
    loadTrendsData('weekly');
}

function loadOverviewStats() {
    fetch('/analytics/overview')
    .then(response => response.json())
    .then(data => {
        const isDarkMode = document.body.classList.contains('dark-mode');
        const textColor = isDarkMode ? '#e0e0e0' : '#333333';
        const borderColors = [
            isDarkMode ? '#0dc1fd' : '#007bff', // Primary
            isDarkMode ? '#28a745' : '#28a745', // Success
            isDarkMode ? '#ffc107' : '#ffc107', // Warning
            isDarkMode ? '#17a2b8' : '#17a2b8', // Info
            isDarkMode ? '#dc3545' : '#dc3545', // Danger
            isDarkMode ? '#6c757d' : '#6c757d'  // Secondary
        ];

 const overviewHtml = `
    <div class="row g-3">
        <div class="col-6 col-md-4 col-lg-2 text-center">
            <div class="card border-primary h-100" style="border-color: ${borderColors[0]} !important">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h2 class="fw-bold display-6 mb-1" style="color: ${borderColors[0]} !important; word-break: break-word;">${data.total_tasks}</h2>
                    <small class="text-muted text-nowrap">Total Tasks</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2 text-center">
            <div class="card border-success h-100" style="border-color: ${borderColors[1]} !important">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h2 class="fw-bold display-6 mb-1" style="color: ${borderColors[1]} !important; word-break: break-word;">${data.completed_tasks}</h2>
                    <small class="text-muted text-nowrap">Completed</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2 text-center">
            <div class="card border-warning h-100" style="border-color: ${borderColors[2]} !important">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h2 class="fw-bold display-6 mb-1" style="color: ${borderColors[2]} !important; word-break: break-word;">${data.pending_tasks}</h2>
                    <small class="text-muted text-nowrap">Pending</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2 text-center">
            <div class="card border-info h-100" style="border-color: ${borderColors[3]} !important">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h2 class="fw-bold display-6 mb-1" style="color: ${borderColors[3]} !important; word-break: break-word;">${data.in_progress_tasks}</h2>
                    <small class="text-muted text-nowrap">In Progress</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2 text-center">
            <div class="card border-danger h-100" style="border-color: ${borderColors[4]} !important">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h2 class="fw-bold display-6 mb-1" style="color: ${borderColors[4]} !important; word-break: break-word;">${data.overdue_tasks}</h2>
                    <small class="text-muted text-nowrap">Overdue</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2 text-center">
             <div class="card border-secondary h-100" style="border-color: ${borderColors[5]} !important">
                  <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h2 class="fw-bold display-6 mb-1" style="color: ${borderColors[5]} !important;">
                         ${Math.round(data.completion_rate)}%
                    </h2>
                    <small class="text-muted text-center d-block">Completion<br>Rate</small>
                  </div>
             </div>
        </div>
    </div>
 </div>
`;

        document.getElementById('analyticsOverview').innerHTML = overviewHtml;
    })
    .catch(error => {
        console.error('Error loading overview stats:', error);
        document.getElementById('analyticsOverview').innerHTML = `
            <div class="col-12 text-center text-danger">
                Error loading analytics data
            </div>
        `;
    });
}

function loadStatusDistribution() {
    fetch('/analytics/status-distribution')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('statusChart');
        if (!ctx) return;

        const isDarkMode = document.body.classList.contains('dark-mode');

        // Define colors that work well in both light and dark modes
        const backgroundColors = [
            'rgba(255, 99, 132, 0.8)',      // Red - Pending
            'rgba(54, 162, 235, 0.8)',      // Blue - In Progress
            'rgba(75, 192, 192, 0.8)',      // Teal - Completed
            'rgba(255, 206, 86, 0.8)',      // Yellow - Other statuses
            'rgba(153, 102, 255, 0.8)',     // Purple
            'rgba(255, 159, 64, 0.8)'       // Orange
        ];

        // Destroy previous chart if it exists
        if (statusChart) {
            statusChart.destroy();
        }

        // Prepare data for chart
        const labels = Object.keys(data);
        const values = Object.values(data);

        // Get text colors based on mode
        const textColor = isDarkMode ? '#e0e0e0' : '#666666';
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

        statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    borderColor: isDarkMode ? 'rgba(255, 255, 255, 0.3)' : 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: textColor,
                            font: {
                                size: 12
                            },
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        },
                        backgroundColor: isDarkMode ? '#2d2d2d' : '#ffffff',
                        titleColor: isDarkMode ? '#e0e0e0' : '#333333',
                        bodyColor: isDarkMode ? '#e0e0e0' : '#666666',
                        borderColor: isDarkMode ? '#3d3d3d' : '#ddd'
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true
                }
            }
        });
    })
    .catch(error => {
        console.error('Error loading status distribution:', error);
    });
}

function loadTrendsData(timeframe) {
    fetch(`/analytics/trends?timeframe=${timeframe}`)
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('trendsChart');
        if (!ctx) return;

        const isDarkMode = document.body.classList.contains('dark-mode');

        // Colors that work in both modes
        const textColor = isDarkMode ? '#e0e0e0' : '#666666';
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const createdColor = 'rgba(54, 162, 235, 1)';
        const completedColor = 'rgba(75, 192, 192, 1)';

        // Destroy previous chart if it exists
        if (trendsChart) {
            trendsChart.destroy();
        }

        // Prepare data for chart
        const labels = data.trends.map(trend => {
            const date = new Date(trend.date);
            return timeframe === 'weekly'
                ? date.toLocaleDateString('en-US', { weekday: 'short' })
                : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        const createdData = data.trends.map(trend => trend.tasks_created);
        const completedData = data.trends.map(trend => trend.tasks_completed);

        trendsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Tasks Created',
                        data: createdData,
                        borderColor: createdColor,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: createdColor,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    },
                    {
                        label: 'Tasks Completed',
                        data: completedData,
                        borderColor: completedColor,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: completedColor,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: textColor,
                            font: {
                                size: 12
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: `Task ${timeframe === 'weekly' ? 'Weekly' : 'Monthly'} Trends`,
                        color: textColor,
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    tooltip: {
                        backgroundColor: isDarkMode ? '#2d2d2d' : '#ffffff',
                        titleColor: isDarkMode ? '#e0e0e0' : '#333333',
                        bodyColor: isDarkMode ? '#e0e0e0' : '#666666',
                        borderColor: isDarkMode ? '#3d3d3d' : '#ddd'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            color: textColor,
                            font: {
                                size: 11
                            }
                        },
                        grid: {
                            color: gridColor
                        }
                    },
                    x: {
                        ticks: {
                            color: textColor,
                            font: {
                                size: 11
                            }
                        },
                        grid: {
                            color: gridColor
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });

        // Update active button state
        document.querySelectorAll('[data-timeframe]').forEach(btn => {
            if (btn.dataset.timeframe === timeframe) {
                btn.classList.add('active');
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary');
            } else {
                btn.classList.remove('active');
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            }
        });
    })
    .catch(error => {
        console.error('Error loading trends data:', error);
    });
}

// Enhanced Dark mode functionality with chart refresh
document.addEventListener('DOMContentLoaded', function() {
  const darkModeToggle = document.getElementById('darkModeToggle');
  const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
  const savedMode = localStorage.getItem('darkMode');

  // Set initial mode based on saved preference or system preference
  let isDarkMode = savedMode ? savedMode === 'true' : prefersDarkScheme.matches;

  // Apply the mode
  setDarkMode(isDarkMode);

  // Update button icon
  updateDarkModeIcon(isDarkMode);

  // Toggle handler
  darkModeToggle.addEventListener('click', function() {
    isDarkMode = !isDarkMode;
    setDarkMode(isDarkMode);
    updateDarkModeIcon(isDarkMode);
    localStorage.setItem('darkMode', isDarkMode);

    // Refresh analytics charts if modal is open
    const analyticsModal = document.getElementById('analyticsModal');
    if (analyticsModal.classList.contains('show')) {
        const currentTimeframe = document.querySelector('[data-timeframe].active')?.dataset.timeframe || 'weekly';
        loadStatusDistribution();
        loadTrendsData(currentTimeframe);
        loadOverviewStats(); // Also refresh overview stats for color changes
    }
  });

  // Listen for system preference changes
  prefersDarkScheme.addEventListener('change', e => {
    if (localStorage.getItem('darkMode') === null) {
      isDarkMode = e.matches;
      setDarkMode(isDarkMode);
      updateDarkModeIcon(isDarkMode);
    }
  });

  function setDarkMode(isDark) {
    if (isDark) {
      document.body.classList.add('dark-mode');
    } else {
      document.body.classList.remove('dark-mode');
    }
  }

  function updateDarkModeIcon(isDark) {
    const icon = darkModeToggle.querySelector('i');
    if (isDark) {
      icon.className = 'fas fa-sun';
    } else {
      icon.className = 'fas fa-moon';
    }
  }
});

// Add event listeners for timeframe buttons
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-timeframe]').forEach(btn => {
        btn.addEventListener('click', function() {
            const timeframe = this.dataset.timeframe;
            loadTrendsData(timeframe);
        });
    });
});
// Enhanced Dark mode functionality
document.addEventListener('DOMContentLoaded', function() {
  const darkModeToggle = document.getElementById('darkModeToggle');
  const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
  const savedMode = localStorage.getItem('darkMode');

  // Set initial mode based on saved preference or system preference
  let isDarkMode = savedMode ? savedMode === 'true' : prefersDarkScheme.matches;

  // Apply the mode
  setDarkMode(isDarkMode);

  // Update button icon
  updateDarkModeIcon(isDarkMode);

  // Toggle handler
  darkModeToggle.addEventListener('click', function() {
    isDarkMode = !isDarkMode;
    setDarkMode(isDarkMode);
    updateDarkModeIcon(isDarkMode);
    localStorage.setItem('darkMode', isDarkMode);
  });

  // Listen for system preference changes
  prefersDarkScheme.addEventListener('change', e => {
    if (localStorage.getItem('darkMode') === null) {
      isDarkMode = e.matches;
      setDarkMode(isDarkMode);
      updateDarkModeIcon(isDarkMode);
    }
  });

  function setDarkMode(isDark) {
    if (isDark) {
      document.body.classList.add('dark-mode');
      // Update Chart.js charts if they exist
      updateChartsForDarkMode();
    } else {
      document.body.classList.remove('dark-mode');
      // Revert Chart.js charts to light mode
      updateChartsForLightMode();
    }
  }

  function updateDarkModeIcon(isDark) {
    darkModeToggle.innerHTML = isDark ?
      '<i class="fas fa-sun"></i>' :
      '<i class="fas fa-moon"></i>';
  }

  function updateChartsForDarkMode() {
    // This would update chart colors for dark mode
    // You can implement this if you're using Chart.js
  }

  function updateChartsForLightMode() {
    // This would revert chart colors for light mode
  }
});
// Function to remove a shared task from user's view
function removeSharedTask(taskId, taskTitle) {
    // Confirmation dialog
    Swal.fire({
        title: 'Remove Shared Task?',
        text: `Are you sure you want to remove "${taskTitle}" from your shared tasks? This will not delete the actual task.`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, remove it!'
    }).then((result) => {
        if (result.isConfirmed) {
            // Get CSRF token
            const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;

            fetch(`/tasks/shared/${taskId}/remove`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    Swal.fire('Error', data.error, 'error');
                } else {
                    // Show success message
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'Task removed from your shared list',
                        showConfirmButton: false,
                        timer: 3000
                    });

                    // Refresh the shared tasks list
                    loadSharedTasks();

                    // Update the shared tasks badge
                    updateSharedTasksBadge();
                }
            })
            .catch(error => {
                console.error('Error removing shared task:', error);
                Swal.fire('Error', 'Failed to remove task: ' + error.message, 'error');
            });
        }
    });
}
</script>
<script>
document.getElementById("deleteAccountForm").addEventListener("submit", async function(e) {
    e.preventDefault(); // stop normal form POST

    const formData = new FormData(this);

    let response = await fetch("/delete_account", {
        method: "POST",
        body: formData
    });

    let result = await response.json();

    if (response.ok) {
        Swal.fire({
            title: "Deleted!",
            text: result.message,
            icon: "success"
        }).then(() => {
            window.location.href = "/login";  // redirect after success
        });
    } else {
        Swal.fire({
            title: "Error",
            text: result.error,
            icon: "error"
        });
    }
});
</script>
</body>
</html>
